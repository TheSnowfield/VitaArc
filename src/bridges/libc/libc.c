#include <stdlib.h>
#include <math.h>
#include <stdio.h>
#include <pthread.h>
#include <ctype.h>
#include <wchar.h>
#include <wctype.h>
#include <locale.h>
#include <dirent.h>
#include <malloc.h>
#include <string.h>
#include <signal.h>
#include <time.h>

#include <sys/types.h>
#include <sys/fcntl.h>
#include <sys/socket.h>
#include <sys/select.h>
#include <sys/stat.h>
#include <sys/unistd.h>
#include <sys/errno.h>

#include <common/define.h>
#include <utils/patcher.h>
#include <logcat/logcat.h>

#include "libc.h"
#include "libcimpl.h"
#include "bionic/bionic.h"

static const BRIDGEFUNC BRIDGE_LIBC[] =
{
  {"__cxa_atexit@@LIBC", (uintptr_t)&__cxa_atexit},
  {"__cxa_finalize@@LIBC", (uintptr_t)&__cxa_finalize},
  {"__errno@@LIBC", (uintptr_t)&__errno},
  // {"__gnu_Unwind_Find_exidx", (uintptr_t)&__gnu_Unwind_Find_exidx},
  {"memcpy_chk@@LIBC", (uintptr_t)&__memcpy_chk},
  {"memset_chk@@LIBC", (uintptr_t)&__memset_chk},
  {"mmap2@@LIBC", (uintptr_t)&mmap2},
  {"__open_2@@LIBC", (uintptr_t)&open},
  {"__stack_chk_fail@@LIBC", (uintptr_t)&__stack_chk_fail},
  {"__stack_chk_guard@@LIBC", (uintptr_t)&__stack_chk_guard},
  {"__strchr_chk@@LIBC", (uintptr_t)&__strchr_chk},
  {"__strlen_chk@@LIBC", (uintptr_t)&__strlen_chk},
  // {"__system_property_get@@LIBC", (uintptr_t)&__system_property_get},
  {"__vsnprintf_chk@@LIBC", (uintptr_t)&__vsnprintf_chk},
  {"__vsprintf_chk@@LIBC", (uintptr_t)&__vsprintf_chk},
  {"abort@@LIBC", (uintptr_t)&abort},
  {"accept@@LIBC", (uintptr_t)&accept},
  {"access@@LIBC", (uintptr_t)&access},
  {"acosf@@LIBC", (uintptr_t)&acosf},
  {"asinf@@LIBC", (uintptr_t)&asinf},
  {"atan2f@@LIBC", (uintptr_t)&atan2f},
  {"atoi@@LIBC", (uintptr_t)&atoi},
  {"atol@@LIBC", (uintptr_t)&atol},
  {"bind@@LIBC", (uintptr_t)&bind},
  {"bsearch@@LIBC", (uintptr_t)&bsearch},
  {"btowc@@LIBC", (uintptr_t)&btowc},
  {"calloc@@LIBC", (uintptr_t)&calloc},
  {"ceilf@@LIBC", (uintptr_t)&ceilf},
  {"clock_gettime@@LIBC", (uintptr_t)&clock_gettime},
  {"close@@LIBC", (uintptr_t)&close},
  {"closedir@@LIBC", (uintptr_t)&closedir},
  {"cosf@@LIBC", (uintptr_t)&cosf},
  {"dladdr@@LIBC", (uintptr_t)&dladdr},
  {"dlclose@@LIBC", (uintptr_t)&dlclose},
  {"dlerror@@LIBC", (uintptr_t)&dlerror},
  {"dlopen@@LIBC", (uintptr_t)&dlopen},
  {"dlsym@@LIBC", (uintptr_t)&dlsym},
  {"exit@@LIBC", (uintptr_t)&exit},
  {"exp2f@@LIBC", (uintptr_t)&exp2f},
  {"fchmod@@LIBC", (uintptr_t)&fchmod},
  {"fchown@@LIBC", (uintptr_t)&fchown},
  {"fclose@@LIBC", (uintptr_t)&fclose},
  {"fcntl@@LIBC", (uintptr_t)&fcntl},
  {"ferror@@LIBC", (uintptr_t)&ferror},
  {"fflush@@LIBC", (uintptr_t)&fflush},
  {"floor@@LIBC", (uintptr_t)&floor},
  {"floorf@@LIBC", (uintptr_t)&floorf},
  {"fmodf@@LIBC", (uintptr_t)&fmodf},
  {"fopen@@LIBC", (uintptr_t)&fopen},
  {"fprintf@@LIBC", (uintptr_t)&fprintf},
  {"fputc@@LIBC", (uintptr_t)&fputc},
  {"fread@@LIBC", (uintptr_t)&fread},
  {"free@@LIBC", (uintptr_t)&free},
  {"freeaddrinfo@@LIBC", (uintptr_t)&freeaddrinfo},
  {"fseek@@LIBC", (uintptr_t)&fseek},
  {"fseeko@@LIBC", (uintptr_t)&fseeko},
  {"fstat@@LIBC", (uintptr_t)&fstat},
  {"fsync@@LIBC", (uintptr_t)&fsync},
  {"ftell@@LIBC", (uintptr_t)&ftell},
  {"ftello@@LIBC", (uintptr_t)&ftello},
  {"ftruncate64@@LIBC", (uintptr_t)&ftruncate64},
  {"fwrite@@LIBC", (uintptr_t)&fwrite},
  {"gai_strerror@@LIBC", (uintptr_t)&gai_strerror},
  {"getaddrinfo@@LIBC", (uintptr_t)&getaddrinfo},
  {"getc@@LIBC", (uintptr_t)&getc},
  {"getcwd@@LIBC", (uintptr_t)&getcwd},
  {"getenv@@LIBC", (uintptr_t)&getenv},
  {"geteuid@@LIBC", (uintptr_t)&geteuid},
  {"getpid@@LIBC", (uintptr_t)&getpid},
  {"gettimeofday@@LIBC", (uintptr_t)&gettimeofday},
  {"gmtime@@LIBC", (uintptr_t)&gmtime},
  {"inet_ntop@@LIBC", (uintptr_t)&inet_ntop},
  {"inet_pton@@LIBC", (uintptr_t)&inet_pton},
  {"ioctl@@LIBC", (uintptr_t)&ioctl},
  {"isalnum@@LIBC", (uintptr_t)&isalnum},
  {"isalpha@@LIBC", (uintptr_t)&isalpha},
  {"isblank@@LIBC", (uintptr_t)&isblank},
  {"islower@@LIBC", (uintptr_t)&islower},
  {"isspace@@LIBC", (uintptr_t)&isspace},
  {"isupper@@LIBC", (uintptr_t)&isupper},
  {"iswalpha@@LIBC", (uintptr_t)&iswalpha},
  {"iswcntrl@@LIBC", (uintptr_t)&iswcntrl},
  {"iswdigit@@LIBC", (uintptr_t)&iswdigit},
  {"iswlower@@LIBC", (uintptr_t)&iswlower},
  {"iswprint@@LIBC", (uintptr_t)&iswprint},
  {"iswpunct@@LIBC", (uintptr_t)&iswpunct},
  {"iswspace@@LIBC", (uintptr_t)&iswspace},
  {"iswupper@@LIBC", (uintptr_t)&iswupper},
  {"iswxdigit@@LIBC", (uintptr_t)&iswxdigit},
  {"isxdigit@@LIBC", (uintptr_t)&isxdigit},
  {"ldexp@@LIBC", (uintptr_t)&ldexp},
  {"listen@@LIBC", (uintptr_t)&listen},
  {"localtime@@LIBC", (uintptr_t)&localtime},
  {"log10f@@LIBC", (uintptr_t)&log10f},
  {"longjmp@@LIBC", (uintptr_t)&longjmp},
  {"lrand48@@LIBC", (uintptr_t)&lrand48},
  {"lseek64@@LIBC", (uintptr_t)&lseek64},
  {"lseek@@LIBC", (uintptr_t)&lseek},
  {"lstat@@LIBC", (uintptr_t)&lstat},
  {"malloc@@LIBC", (uintptr_t)&malloc},
  {"mbrlen@@LIBC", (uintptr_t)&mbrlen},
  {"memalign@@LIBC", (uintptr_t)&memalign},
  {"memchr@@LIBC", (uintptr_t)&memchr},
  {"memcmp@@LIBC", (uintptr_t)&memcmp},
  {"memcpy@@LIBC", (uintptr_t)&memcpy},
  {"memmem@@LIBC", (uintptr_t)&memmem},
  {"memmove@@LIBC", (uintptr_t)&memmove},
  {"memset@@LIBC", (uintptr_t)&memset},
  {"mkdir@@LIBC", (uintptr_t)&mkdir},
  {"modf@@LIBC", (uintptr_t)&modf},
  {"mremap@@LIBC", (uintptr_t)&mremap},
  {"munmap@@LIBC", (uintptr_t)&munmap},
  {"nanosleep@@LIBC", (uintptr_t)&nanosleep},
  {"open@@LIBC", (uintptr_t)&open},
  {"opendir@@LIBC", (uintptr_t)&opendir},
  {"perror@@LIBC", (uintptr_t)&perror},
  {"pow@@LIBC", (uintptr_t)&pow},
  {"powf@@LIBC", (uintptr_t)&powf},
  {"printf@@LIBC", (uintptr_t)&printf},
  {"pthread_cond_broadcast@@LIBC", (uintptr_t)&pthread_cond_broadcast},
  {"pthread_cond_destroy@@LIBC", (uintptr_t)&pthread_cond_destroy},
  {"pthread_cond_signal@@LIBC", (uintptr_t)&pthread_cond_signal},
  {"pthread_cond_timedwait@@LIBC", (uintptr_t)&pthread_cond_timedwait},
  {"pthread_cond_wait@@LIBC", (uintptr_t)&pthread_cond_wait},
  {"pthread_create@@LIBC", (uintptr_t)&pthread_create},
  {"pthread_detach@@LIBC", (uintptr_t)&pthread_detach},
  {"pthread_equal@@LIBC", (uintptr_t)&pthread_equal},
  {"pthread_getspecific@@LIBC", (uintptr_t)&pthread_getspecific},
  {"pthread_join@@LIBC", (uintptr_t)&pthread_join},
  {"pthread_key_create@@LIBC", (uintptr_t)&pthread_key_create},
  {"pthread_key_delete@@LIBC", (uintptr_t)&pthread_key_delete},
  {"pthread_mutex_destroy@@LIBC", (uintptr_t)&pthread_mutex_destroy},
  {"pthread_mutex_init@@LIBC", (uintptr_t)&pthread_mutex_init},
  {"pthread_mutex_lock@@LIBC", (uintptr_t)&pthread_mutex_lock},
  {"pthread_mutex_trylock@@LIBC", (uintptr_t)&pthread_mutex_trylock},
  {"pthread_mutex_unlock@@LIBC", (uintptr_t)&pthread_mutex_unlock},
  {"pthread_mutexattr_destroy@@LIBC", (uintptr_t)&pthread_mutexattr_destroy},
  {"pthread_mutexattr_init@@LIBC", (uintptr_t)&pthread_mutexattr_init},
  {"pthread_mutexattr_settype@@LIBC", (uintptr_t)&pthread_mutexattr_settype},
  {"pthread_once@@LIBC", (uintptr_t)&pthread_once},
  {"pthread_self@@LIBC", (uintptr_t)&pthread_self},
  {"pthread_setspecific@@LIBC", (uintptr_t)&pthread_setspecific},
  {"puts@@LIBC", (uintptr_t)&puts},
  {"qsort@@LIBC", (uintptr_t)&qsort},
  {"raise@@LIBC", (uintptr_t)&raise},
  {"read@@LIBC", (uintptr_t)&read},
  {"readlink@@LIBC", (uintptr_t)&readlink},
  {"realloc@@LIBC", (uintptr_t)&realloc},
  {"recvfrom@@LIBC", (uintptr_t)&recvfrom},
  {"remove@@LIBC", (uintptr_t)&remove},
  {"rename@@LIBC", (uintptr_t)&rename},
  {"rmdir@@LIBC", (uintptr_t)&rmdir},
  {"roundf@@LIBC", (uintptr_t)&roundf},
  {"scalbn@@LIBC", (uintptr_t)&scalbn},
  {"sched_yield@@LIBC", (uintptr_t)&sched_yield},
  {"select@@LIBC", (uintptr_t)&select},
  {"sendto@@LIBC", (uintptr_t)&sendto},
  {"setjmp@@LIBC", (uintptr_t)&setjmp},
  {"setsockopt@@LIBC", (uintptr_t)&setsockopt},
  {"sincos@@LIBC", (uintptr_t)&sincos},
  {"sincosf@@LIBC", (uintptr_t)&sincosf},
  {"sinf@@LIBC", (uintptr_t)&sinf},
  {"snprintf@@LIBC", (uintptr_t)&snprintf},
  {"socket@@LIBC", (uintptr_t)&socket},
  {"sprintf@@LIBC", (uintptr_t)&sprintf},
  {"srand48@@LIBC", (uintptr_t)&srand48},
  {"sscanf@@LIBC", (uintptr_t)&sscanf},
  {"stat@@LIBC", (uintptr_t)&stat},
  {"strcasecmp@@LIBC", (uintptr_t)&strcasecmp},
  {"strcat@@LIBC", (uintptr_t)&strcat},
  {"strchr@@LIBC", (uintptr_t)&strchr},
  {"strcmp@@LIBC", (uintptr_t)&strcmp},
  {"strcoll@@LIBC", (uintptr_t)&strcoll},
  {"strcpy@@LIBC", (uintptr_t)&strcpy},
  {"strcspn@@LIBC", (uintptr_t)&strcspn},
  {"strdup@@LIBC", (uintptr_t)&strdup},
  {"strerror@@LIBC", (uintptr_t)&strerror},
  {"strerror_r@@LIBC", (uintptr_t)&strerror_r},
  {"strftime@@LIBC", (uintptr_t)&strftime},
  {"strlen@@LIBC", (uintptr_t)&strlen},
  {"strncmp@@LIBC", (uintptr_t)&strncmp},
  {"strncpy@@LIBC", (uintptr_t)&strncpy},
  {"strrchr@@LIBC", (uintptr_t)&strrchr},
  {"strspn@@LIBC", (uintptr_t)&strspn},
  {"strstr@@LIBC", (uintptr_t)&strstr},
  {"strtod@@LIBC", (uintptr_t)&strtod},
  {"strtoimax@@LIBC", (uintptr_t)&strtoimax},
  {"strtok@@LIBC", (uintptr_t)&strtok},
  {"strtol@@LIBC", (uintptr_t)&strtol},
  {"strtoll@@LIBC", (uintptr_t)&strtoll},
  {"strtoul@@LIBC", (uintptr_t)&strtoul},
  {"strtoull@@LIBC", (uintptr_t)&strtoull},
  {"strtoumax@@LIBC", (uintptr_t)&strtoumax},
  {"strxfrm@@LIBC", (uintptr_t)&strxfrm},
  {"syscall@@LIBC", (uintptr_t)&syscall},
  {"sysconf@@LIBC", (uintptr_t)&sysconf},
  {"tanf@@LIBC", (uintptr_t)&tanf},
  {"time@@LIBC", (uintptr_t)&time},
  {"tolower@@LIBC", (uintptr_t)&tolower},
  {"toupper@@LIBC", (uintptr_t)&toupper},
  {"towlower@@LIBC", (uintptr_t)&towlower},
  {"towupper@@LIBC", (uintptr_t)&towupper},
  {"ungetc@@LIBC", (uintptr_t)&ungetc},
  {"unlink@@LIBC", (uintptr_t)&unlink},
  {"utimes@@LIBC", (uintptr_t)&utimes},
  {"vasprintf@@LIBC", (uintptr_t)&vasprintf},
  {"vfprintf@@LIBC", (uintptr_t)&vfprintf},
  {"vsnprintf@@LIBC", (uintptr_t)&vsnprintf},
  {"vsscanf@@LIBC", (uintptr_t)&vsscanf},
  {"wcscoll@@LIBC", (uintptr_t)&wcscoll},
  {"wcsxfrm@@LIBC", (uintptr_t)&wcsxfrm},
  {"wctob@@LIBC", (uintptr_t)&wctob},
  {"write@@LIBC", (uintptr_t)&write}
};

void bridgePatchLibC(HSOLIB hSoLibrary)
{
  patchSymbols(hSoLibrary, BRIDGE_LIBC, sizeof(BRIDGE_LIBC) / sizeof(BRIDGEFUNC));
}
