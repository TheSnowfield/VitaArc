#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <pthread.h>
#include <ctype.h>
#include <wchar.h>
#include <wctype.h>
#include <locale.h>
#include <dirent.h>
#include <malloc.h>
#include <string.h>
#include <signal.h>
#include <time.h>

#include <sys/types.h>
#include <sys/fcntl.h>
#include <sys/socket.h>
#include <sys/select.h>
#include <sys/stat.h>
#include <sys/unistd.h>
#include <sys/errno.h>

#include <common/define.h>
#include <utils/patcher.h>
#include <logcat/logcat.h>

#include "libc.h"
#include "impl/libc.h"
#include "impl/pthread.h"
#include "impl/bionic/bionic.h"

static const BRIDGEFUNC BRIDGE_LIBC[] =
{
  {"__cxa_atexit", (uintptr_t)&__cxa_atexit},
  {"__cxa_finalize", (uintptr_t)&__cxa_finalize},
  {"__errno", (uintptr_t)&__errno},
  {"__gnu_Unwind_Find_exidx", (uintptr_t)&__gnu_Unwind_Find_exidx},
  {"__memcpy_chk", (uintptr_t)&__memcpy_chk},
  {"__memset_chk", (uintptr_t)&__memset_chk},
  {"__mmap2", (uintptr_t)&mmap2},
  {"__open_2", (uintptr_t)&open},
  /* OS Crashed */ // {"__stack_chk_fail", (uintptr_t)&__stack_chk_fail},
  /* OS Crashed */ // {"__stack_chk_guard", (uintptr_t)&__stack_chk_guard},
  {"__stack_chk_fail", (uintptr_t)&__stack_chk_fail},
  {"__stack_chk_guard", (uintptr_t)&__stack_chk_guard},
  {"__strchr_chk", (uintptr_t)&__strchr_chk},
  {"__strlen_chk", (uintptr_t)&__strlen_chk},
  // {"__system_property_get", (uintptr_t)&__system_property_get},
  {"__vsnprintf_chk", (uintptr_t)&__vsnprintf_chk},
  {"__vsprintf_chk", (uintptr_t)&__vsprintf_chk},
  {"__assert2", (uintptr_t)&__assert2},
  {"abort", (uintptr_t)&abort},
  {"accept", (uintptr_t)&accept},
  {"access", (uintptr_t)&access},
  {"acos", (uintptr_t)&acos},
  {"acosf", (uintptr_t)&acosf},
  {"asinf", (uintptr_t)&asinf},
  {"atan2f", (uintptr_t)&atan2f},
  {"atoi", (uintptr_t)&atoi},
  {"atol", (uintptr_t)&atol},
  {"bind", (uintptr_t)&bind},
  {"bsearch", (uintptr_t)&bsearch},
  {"btowc", (uintptr_t)&btowc},
  {"calloc", (uintptr_t)&calloc},
  {"ceil", (uintptr_t)&ceil},
  {"ceilf", (uintptr_t)&ceilf},
  {"clock_gettime", (uintptr_t)&clock_gettime},
  {"close", (uintptr_t)&_close},
  {"closedir", (uintptr_t)&closedir},
  {"cos", (uintptr_t)&cos},
  {"cosf", (uintptr_t)&cosf},
  {"dladdr", (uintptr_t)&dladdr},
  {"dlclose", (uintptr_t)&dlclose},
  {"dlerror", (uintptr_t)&dlerror},
  {"dlopen", (uintptr_t)&dlopen},
  {"dlsym", (uintptr_t)&dlsym},
  {"exit", (uintptr_t)&exit},
  {"exp2f", (uintptr_t)&exp2f},
  {"fchmod", (uintptr_t)&fchmod},
  {"fchown", (uintptr_t)&fchown},
  {"fclose", (uintptr_t)&fclose},
  {"fcntl", (uintptr_t)&fcntl},
  {"ferror", (uintptr_t)&ferror},
  {"fflush", (uintptr_t)&fflush},
  {"floor", (uintptr_t)&floor},
  {"floorf", (uintptr_t)&floorf},
  {"fmodf", (uintptr_t)&fmodf},
  {"fopen", (uintptr_t)&_fopen},
  {"fprintf", (uintptr_t)&fprintf},
  {"fputc", (uintptr_t)&fputc},
  {"fread", (uintptr_t)&fread},
  {"free", (uintptr_t)&free},
  {"freeaddrinfo", (uintptr_t)&freeaddrinfo},
  {"fseek", (uintptr_t)&fseek},
  {"fseeko", (uintptr_t)&fseeko},
  {"fstat", (uintptr_t)&fstat},
  {"fsync", (uintptr_t)&fsync},
  {"ftell", (uintptr_t)&ftell},
  {"ftello", (uintptr_t)&ftello},
  {"ftruncate64", (uintptr_t)&ftruncate64},
  {"fwrite", (uintptr_t)&fwrite},
  {"gai_strerror", (uintptr_t)&gai_strerror},
  {"getaddrinfo", (uintptr_t)&getaddrinfo},
  {"getc", (uintptr_t)&getc},
  {"getcwd", (uintptr_t)&getcwd},
  {"getenv", (uintptr_t)&getenv},
  {"geteuid", (uintptr_t)&geteuid},
  {"getpid", (uintptr_t)&getpid},
  {"gettimeofday", (uintptr_t)&gettimeofday},
  {"gmtime", (uintptr_t)&gmtime},
  {"inet_ntop", (uintptr_t)&inet_ntop},
  {"inet_pton", (uintptr_t)&inet_pton},
  {"ioctl", (uintptr_t)&ioctl},
  {"isalnum", (uintptr_t)&isalnum},
  {"isalpha", (uintptr_t)&isalpha},
  {"isblank", (uintptr_t)&isblank},
  {"islower", (uintptr_t)&islower},
  {"isspace", (uintptr_t)&isspace},
  {"isupper", (uintptr_t)&isupper},
  {"iswalpha", (uintptr_t)&iswalpha},
  {"iswcntrl", (uintptr_t)&iswcntrl},
  {"iswdigit", (uintptr_t)&iswdigit},
  {"iswlower", (uintptr_t)&iswlower},
  {"iswprint", (uintptr_t)&iswprint},
  {"iswpunct", (uintptr_t)&iswpunct},
  {"iswspace", (uintptr_t)&iswspace},
  {"iswupper", (uintptr_t)&iswupper},
  {"iswxdigit", (uintptr_t)&iswxdigit},
  {"isxdigit", (uintptr_t)&isxdigit},
  {"ldexp", (uintptr_t)&ldexp},
  {"listen", (uintptr_t)&listen},
  {"localtime", (uintptr_t)&localtime},
  {"log10f", (uintptr_t)&log10f},
  {"longjmp", (uintptr_t)&longjmp},
  {"lrand48", (uintptr_t)&lrand48},
  {"lseek64", (uintptr_t)&lseek64},
  {"lseek", (uintptr_t)&lseek},
  {"lstat", (uintptr_t)&lstat},
  {"malloc", (uintptr_t)&malloc},
  {"mbrlen", (uintptr_t)&mbrlen},
  {"memalign", (uintptr_t)&memalign},
  {"memchr", (uintptr_t)&memchr},
  {"memcmp", (uintptr_t)&memcmp},
  {"memcpy", (uintptr_t)&memcpy},
  {"memmem", (uintptr_t)&memmem},
  {"memmove", (uintptr_t)&memmove},
  {"memset", (uintptr_t)&memset},
  {"mkdir", (uintptr_t)&mkdir},
  {"modf", (uintptr_t)&modf},
  {"mremap", (uintptr_t)&mremap},
  {"munmap", (uintptr_t)&munmap},
  {"nanosleep", (uintptr_t)&nanosleep},
  {"open", (uintptr_t)&_open},
  {"opendir", (uintptr_t)&opendir},
  {"perror", (uintptr_t)&perror},
  {"pow", (uintptr_t)&pow},
  {"powf", (uintptr_t)&powf},
  {"printf", (uintptr_t)&logPrintf},
  {"pthread_cond_broadcast", (uintptr_t)&_pthread_cond_broadcast},
  {"pthread_cond_destroy", (uintptr_t)&_pthread_cond_destroy},
  {"pthread_cond_signal", (uintptr_t)&_pthread_cond_signal},
  {"pthread_cond_timedwait", (uintptr_t)&_pthread_cond_timedwait},
  {"pthread_cond_wait", (uintptr_t)&_pthread_cond_wait},
  {"pthread_create", (uintptr_t)&_pthread_create},
  {"pthread_detach", (uintptr_t)&_pthread_detach},
  {"pthread_equal", (uintptr_t)&_pthread_equal},
  {"pthread_getspecific", (uintptr_t)&_pthread_getspecific},
  {"pthread_join", (uintptr_t)&_pthread_join},
  {"pthread_key_create", (uintptr_t)&_pthread_key_create},
  {"pthread_key_delete", (uintptr_t)&_pthread_key_delete},
  {"pthread_mutex_destroy", (uintptr_t)&_pthread_mutex_destroy},
  {"pthread_mutex_init", (uintptr_t)&_pthread_mutex_init},
  {"pthread_mutex_lock", (uintptr_t)&_pthread_mutex_lock},
  {"pthread_mutex_trylock", (uintptr_t)&_pthread_mutex_trylock},
  {"pthread_mutex_unlock", (uintptr_t)&_pthread_mutex_unlock},
  {"pthread_mutexattr_destroy", (uintptr_t)&_pthread_mutexattr_destroy},
  {"pthread_mutexattr_init", (uintptr_t)&_pthread_mutexattr_init},
  {"pthread_mutexattr_settype", (uintptr_t)&_pthread_mutexattr_settype},
  {"pthread_once", (uintptr_t)&_pthread_once},
  {"pthread_self", (uintptr_t)&_pthread_self},
  {"pthread_setspecific", (uintptr_t)&_pthread_setspecific},
  {"puts", (uintptr_t)&puts},
  {"qsort", (uintptr_t)&qsort},
  // {"raise", (uintptr_t)&raise},
  {"read", (uintptr_t)&_read},
  {"readlink", (uintptr_t)&readlink},
  {"realloc", (uintptr_t)&realloc},
  {"recvfrom", (uintptr_t)&recvfrom},
  {"remove", (uintptr_t)&remove},
  {"rename", (uintptr_t)&rename},
  {"rmdir", (uintptr_t)&rmdir},
  {"roundf", (uintptr_t)&roundf},
  {"scalbn", (uintptr_t)&scalbn},
  {"sched_yield", (uintptr_t)&sched_yield},
  {"select", (uintptr_t)&select},
  {"sendto", (uintptr_t)&sendto},
  {"setjmp", (uintptr_t)&setjmp},
  {"setsockopt", (uintptr_t)&setsockopt},
  {"sincos", (uintptr_t)&sincos},
  {"sincosf", (uintptr_t)&sincosf},
  {"sinf", (uintptr_t)&sinf},
  {"snprintf", (uintptr_t)&snprintf},
  {"socket", (uintptr_t)&socket},
  {"sprintf", (uintptr_t)&sprintf},
  {"srand48", (uintptr_t)&srand48},
  {"sscanf", (uintptr_t)&sscanf},
  {"stat", (uintptr_t)&stat},
  {"strcasecmp", (uintptr_t)&strcasecmp},
  {"strcat", (uintptr_t)&strcat},
  {"strchr", (uintptr_t)&strchr},
  {"strcmp", (uintptr_t)&strcmp},
  {"strcoll", (uintptr_t)&strcoll},
  {"strcpy", (uintptr_t)&strcpy},
  {"strcspn", (uintptr_t)&strcspn},
  {"strdup", (uintptr_t)&strdup},
  {"strerror", (uintptr_t)&strerror},
  {"strerror_r", (uintptr_t)&strerror_r},
  {"strftime", (uintptr_t)&strftime},
  {"strlen", (uintptr_t)&_strlen},
  {"strncmp", (uintptr_t)&strncmp},
  {"strncpy", (uintptr_t)&strncpy},
  {"strrchr", (uintptr_t)&strrchr},
  {"strspn", (uintptr_t)&strspn},
  {"strstr", (uintptr_t)&strstr},
  {"strtod", (uintptr_t)&strtod},
  {"strtoimax", (uintptr_t)&strtoimax},
  {"strtok", (uintptr_t)&strtok},
  {"strtol", (uintptr_t)&strtol},
  {"strtoll", (uintptr_t)&strtoll},
  {"strtoul", (uintptr_t)&strtoul},
  {"strtoull", (uintptr_t)&strtoull},
  {"strtoumax", (uintptr_t)&strtoumax},
  {"strxfrm", (uintptr_t)&strxfrm},
  {"syscall", (uintptr_t)&syscall},
  {"sysconf", (uintptr_t)&sysconf},
  {"tanf", (uintptr_t)&tanf},
  {"time", (uintptr_t)&time},
  {"tolower", (uintptr_t)&tolower},
  {"toupper", (uintptr_t)&toupper},
  {"towlower", (uintptr_t)&towlower},
  {"towupper", (uintptr_t)&towupper},
  {"ungetc", (uintptr_t)&ungetc},
  {"unlink", (uintptr_t)&unlink},
  {"utimes", (uintptr_t)&utimes},
  {"vasprintf", (uintptr_t)&vasprintf},
  {"vfprintf", (uintptr_t)&vfprintf},
  {"vsnprintf", (uintptr_t)&vsnprintf},
  {"vsscanf", (uintptr_t)&vsscanf},
  {"wcscoll", (uintptr_t)&wcscoll},
  {"wcsxfrm", (uintptr_t)&wcsxfrm},
  {"wctob", (uintptr_t)&wctob},
  {"write", (uintptr_t)&write}
};

void bridgePatchLibC(HSOLIB hSoLibrary)
{
  patchSymbols(hSoLibrary, BRIDGE_LIBC, sizeof(BRIDGE_LIBC) / sizeof(BRIDGEFUNC));
}
